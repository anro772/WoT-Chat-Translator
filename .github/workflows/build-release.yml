name: Build Open Source Release

on:
  push:
    branches: [ main ]
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: write  # Allow creating releases

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 2.7
      run: |
        sudo apt-get update
        sudo apt-get install -y python2.7
        sudo update-alternatives --install /usr/bin/python python /usr/bin/python2.7 1
        python --version
    
    - name: Build OPEN SOURCE version (NO KEYS)
      run: |
        # DO NOT inject any keys - keep placeholders
        # This version requires users to add their own keys
        
        # Create a notice file
        cat > IMPORTANT_README.txt << 'EOF'
        ==========================================
        IMPORTANT: API KEY REQUIRED
        ==========================================
        
        This is the OPEN SOURCE version of the Chat Translator.
        
        YOU MUST ADD YOUR OWN API KEY to use this mod:
        
        1. Get a FREE Microsoft Translator API key:
           https://azure.microsoft.com/free/cognitive-services/
           (2 million characters free per month!)
        
        2. Edit mod_MicrosoftTranslator.py and replace:
           - YOUR_API_KEY_HERE with your actual API key
           - YOUR_REGION_HERE with your Azure region
        
        3. Build the mod:
           python build.py
        
        4. Install the generated .wotmod file
        
        For detailed instructions, see:
        https://github.com/${{ github.repository }}
        
        ==========================================
        EOF
        
        # Build without keys (will have placeholders)
        python build.py || true  # Allow failure since no keys
        
        # Create a source bundle for users to build themselves
        mkdir -p dist
        zip -r dist/ChatTranslator_SOURCE.zip \
          mod_MicrosoftTranslator.py \
          build.py \
          .env.example \
          README.md \
          IMPORTANT_README.txt \
          LICENSE
    
    - name: Upload source bundle
      uses: actions/upload-artifact@v4
      with:
        name: ChatTranslator-Source
        path: dist/ChatTranslator_SOURCE.zip
    
    - name: Create Release
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: softprops/action-gh-release@v2
      with:
        files: dist/ChatTranslator_SOURCE.zip
        tag_name: v${{ github.run_number }}
        name: Release v${{ github.run_number }} - Open Source
        body: |
          ## ⚠️ IMPORTANT: This is the OPEN SOURCE version
          
          **You MUST add your own API key to use this mod!**
          
          ### What's Included
          📦 **ChatTranslator_SOURCE.zip** - Source code bundle
          
          ### How to Use
          1. Download and extract ChatTranslator_SOURCE.zip
          2. Get your FREE API key from [Microsoft Azure](https://azure.microsoft.com/free/cognitive-services/)
          3. Edit the source code or use .env file to add your keys
          4. Run `python build.py` to create your personal .wotmod
          5. Install in World of Tanks
          
          ### Why No Pre-built .wotmod?
          To protect API keys and ensure each user has their own quota, we don't distribute pre-built versions with embedded keys.
          
          ### Features
          - 🌍 Auto-detects and translates 60+ languages
          - ⚡ No performance impact (async translation)
          - 💬 Works in platoon, training, and battle chat
          - 🎯 Smart English detection
          - 📊 Language confidence scores
          
          ### Need Help?
          See the [README](https://github.com/${{ github.repository }}) for detailed instructions.
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}